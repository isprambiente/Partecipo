// dnode@0.9.12 downloaded from https://ga.jspm.io/npm:dnode@0.9.12/index.js

import e from"net";import t from"tls";import r from"http";import n from"events";import o from"dnode-protocol";import i from"lazy";import s from"stream";import c from"socket.io";import a from"fs";import d from"process";var l={};var u=n.EventEmitter;var f=s.Stream;var h=c;var m=a;var p=function(){var e=null;var t=new URL(import.meta.url.slice(0,import.meta.url.lastIndexOf("/"))).pathname+"/../browser/bundle.js";return function(r,n){if(e){var o={"content-type":"text/javascript","last-modified":e.modified.toGMTString(),date:(new Date).toGMTString()};var i=r.headers["if-modified-since"];if(i){var s=new Date(i);if(s>=e.modified){n.writeHead(304,o);n.end();return}}n.writeHead(200,o);n.end(e.source)}else m.stat(t,(function(o,i){m.readFile(t,(function(t,s){if(o||t){var c=o||t;console.error(c.message||c);n.writeHead(500,{"content-type":"text/plain"});n.end("an error occured loading the bundle")}else{e={source:s,modified:i.mtime};p(r,n)}}))}))}}();l=function(e,t,r){void 0===r["log level"]&&(r["log level"]=-1);var n=h.listen(e,r);n.set("logger",{error:function(){},warn:function(){},info:function(){},debug:function(){}});var o=new u;o.socket=n;if(t&&e.use)e.use((function(e,r,n){e.url.split("?")[0]===t?p(e,r):n()}));else if(t){e._events||(e._events={});var i=e._events;i.request||(i.request=[]);Array.isArray(i.request)||(i.request=[i.request]);i.request.push((function(e,r){r.finished||e.url.split("?")[0]!==t||p(e,r)}))}n.sockets.on("connection",(function(e){var t=new f;t.socketio=e;t.readable=true;t.writable=true;t.write=e.send.bind(e);t.end=t.destroy=e.disconnect.bind(e);e.on("message",t.emit.bind(t,"data"));e.on("error",t.emit.bind(t,"error"));e.on("disconnect",(function(){t.writable=false;t.readable=false;t.emit("end")}));o.emit("connection",t)}));return o};var v=l;var b="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var y={};var w=d;var k=e;var g=t;var E=r;var C=n.EventEmitter;var S=o;var q=i;var T=v;y=y=dnode;function dnode(e){if(!((this||b)instanceof dnode))return new dnode(e);(this||b).proto=S(e);(this||b).stack=[];(this||b).streams=[];return this||b}dnode.prototype=new C;dnode.prototype.use=function(e){(this||b).stack.push(e);return this||b};dnode.prototype.connect=function(){var e=S.parseArgs(arguments);var t=e.stream;var r=null;var n=this||b;if(e.port){e.host=e.host||"127.0.0.1";if(e.key){var o={key:e.key,cert:e.cert,ca:e.ca,requestCert:e.requestCert,rejectUnauthorized:e.rejectUnauthorized};t=g.connect(e.port,e.host,o,(function(){attachDnode()}))}else{t=k.createConnection(e.port,e.host);t.on("connect",(function(){attachDnode()}))}}else if(e.path){t=k.createConnection(e.path);t.on("connect",(function(){attachDnode()}))}else attachDnode();t.remoteAddress=e.host;t.remotePort=e.port;var i=arguments;if(e.reconnect){t.on("error",function(t){if("ECONNREFUSED"===t.code||"ENOENT"===t.code){r&&r.emit("refused");setTimeout(function(){r&&r.emit("reconnect");dnode.prototype.connect.apply(this||b,i)}.bind(this||b),e.reconnect)}else r?r.emit("error",t):this.emit("error",t)}.bind(this||b));t.once("end",function(){if(e.reconnect){r.emit("drop");setTimeout(function(){if(e.reconnect){r.emit("reconnect");dnode.prototype.connect.apply(this||b,i)}}.bind(this||b),e.reconnect)}}.bind(this||b))}else t.on("error",function(e){r?r.emit("error",e):this.emit("error",e)}.bind(this||b));function attachDnode(){if(!t){n.emit("error",new Error("Could not create a stream with this information "+JSON.stringify(e)));return null}r=createClient(n.proto,t);r.end=function(){e.reconnect&&(e.reconnect=0);t.end()};n.stack.forEach((function(e){e.call(r.instance,r.remote,r)}));e.block&&r.on("remote",(function(){e.block.call(r.instance,r.remote,r)}));w.nextTick((function(){0===r.listeners("error").length&&r.on("error",(function(e){console.error(e&&e.stack||e)}))}));r.start()}(this||b).streams.push(t);return this||b};dnode.prototype.listen=function(){var e=this||b;var t=S.parseArgs(arguments);var r=t.server;if(t.port)if(t.key){var n={key:t.key,cert:t.cert,ca:t.ca,requestCert:t.requestCert,rejectUnauthorized:t.rejectUnauthorized};r=g.createServer(n);r.on("error",(this||b).emit.bind(this||b,"error"));t.host?r.listen(t.port,t.host,(this||b).emit.bind(this||b,"ready")):r.listen(t.port,(this||b).emit.bind(this||b,"ready"))}else{r=k.createServer();r.on("error",(this||b).emit.bind(this||b,"error"));r.listen(t.port,t.host,(this||b).emit.bind(this||b,"ready"))}else if(t.path){r=k.createServer();r.on("error",(this||b).emit.bind(this||b,"error"));r.listen(t.path,(this||b).emit.bind(this||b,"ready"))}else r&&(r instanceof E.Server||r.hasOwnProperty("httpAllowHalfOpen")||t.webserver)&&(r=T(r||t.webserver,void 0===t.mount?"/dnode.js":t.mount,t.io||{}));r||this.emit("error",new Error("Not sure how to fire up this listener"));var o={};var i=r instanceof g.Server?"secureConnection":"connection";r.on(i,(function(r){var n=createClient(e.proto,r);o[n.id]=n;e.stack.forEach((function(e){e.call(n.instance,n.remote,n)}));t.block&&n.on("remote",(function(){t.block.call(n.instance,n.remote,n)}));n.start()}));(this||b).server=r;r.on("close",(this||b).emit.bind(this||b,"close"));return this||b};function createClient(e,t){var r=e.create();w.nextTick((function(){0===r.listeners("error").length&&r.on("error",(function(e){console.error(e&&e.stack||e)}))}));r.stream=t;r.end=t.end.bind(t);r.destroy=t.destroy.bind(t);t.on("end",r.emit.bind(r,"end"));t.on("disconnect",r.emit.bind(r,"disconnect"));t.on("close",r.emit.bind(r,"close"));r.on("request",(function(e){t.writable?t.write(JSON.stringify(e)+"\n"):r.emit("dropped",e)}));q(t).lines.map(String).forEach(r.parse);return r}dnode.prototype.end=function(){Object.keys((this||b).proto.sessions).forEach(function(e){(this||b).proto.sessions[e].stream.end()}.bind(this||b));this.emit("end")};dnode.prototype.close=function(){var e=this||b;try{e.server.close()}catch(t){"Not running"===t.message?e.server.emit("close"):e.server.emit("error",t)}};dnode.connect=function(){var e=dnode();return e.connect.apply(e,arguments)};dnode.listen=function(){var e=dnode();return e.listen.apply(e,arguments)};var j=y;export default j;

