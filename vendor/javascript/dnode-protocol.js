// dnode-protocol@0.1.5 downloaded from https://ga.jspm.io/npm:dnode-protocol@0.1.5/index.js

import e from"traverse";import t from"events";import r from"jsonify";var n="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:global;var o={};var a={exports:o};var i=e;var s=t.EventEmitter;var u="object"===typeof JSON?JSON:r;var c=Object.keys||function(e){var t=[];for(var r in e)t.push(r);return t};function forEach(e,t){if(e.forEach)return e.forEach(t);for(var r=0;r<e.length;r++)t.call(e,e[r],r)}var o=a.exports=function(e){var t={};t.sessions={};t.create=function(){var r=null;do{r=Math.floor(Math.random()*Math.pow(2,32)).toString(16)}while(t.sessions[r]);var n=f(r,e);t.sessions[r]=n;return n};t.destroy=function(e){delete t.sessions[e]};return t};var f=o.Session=function(e,t){var r=new s;r.id=e;r.remote={};var n=r.instance="function"==typeof t?new t(r.remote,r):t||{};r.localStore=new p;r.remoteStore=new p;r.localStore.on("cull",(function(e){r.emit("request",{method:"cull",arguments:[e],callbacks:{}})}));var o=new l(r.localStore);r.start=function(){r.request("methods",[n])};r.request=function(e,t){var n=o.scrub(t);r.emit("request",{method:e,arguments:n.arguments,callbacks:n.callbacks,links:n.links})};r.parse=function(e){var t=null;try{t=u.parse(e)}catch(t){r.emit("error",new SyntaxError("Error parsing JSON message: "+u.stringify(e)));return}try{r.handle(t)}catch(e){r.emit("error",e)}};r.handle=function(e){var t=o.unscrub(e,(function(e){r.remoteStore.has(e)||r.remoteStore.add((function(){r.request(e,[].slice.apply(arguments))}),e);return r.remoteStore.get(e)}));if("methods"===e.method)handleMethods(t[0]);else if("error"===e.method){var n=t[0];r.emit("remoteError",n)}else"cull"===e.method?forEach(t,(function(e){r.remoteStore.cull(t)})):"string"===typeof e.method?r.instance.propertyIsEnumerable(e.method)?apply(r.instance[e.method],r.instance,t):r.emit("error",new Error("Request for non-enumerable method: "+e.method)):"number"==typeof e.method&&apply(r.localStore.get(e.method),r.instance,t)};function handleMethods(e){"object"!=typeof e&&(e={});forEach(c(r.remote),(function(e){delete r.remote[e]}));forEach(c(e),(function(t){r.remote[t]=e[t]}));r.emit("remote",r.remote);r.emit("ready")}function apply(e,t,n){try{e.apply(t,n)}catch(e){r.emit("error",e)}}return r};var l=o.Scrubber=function(e){var t={};e=e||new p;t.callbacks=e.items;t.scrub=function(t){var r={};var o=[];var a=i(t).map((function(t){if("function"==typeof t){var a=e.indexOf(t);if(a>=0&&!(a in r))r[a]=(this||n).path;else{var i=e.add(t);r[i]=(this||n).path}this.update("[Function]")}else if((this||n).circular){o.push({from:(this||n).circular.path,to:(this||n).path});this.update("[Circular]")}}));return{arguments:a,callbacks:r,links:o}};t.unscrub=function(e,t){var r=e.arguments||[];forEach(c(e.callbacks||{}),(function(n){var o=parseInt(n,10);var a=e.callbacks[o];r=setAt(r,a,t(o))}));forEach(e.links||[],(function(e){var t=getAt(r,e.from);r=setAt(r,e.to,t)}));return r};function setAt(e,t,r){var n=e;for(var o=0;o<t.length-1;o++){var a=t[o];if(!Object.propertyIsEnumerable.call(n,a))return;n=n[a]}var i=t.slice(-1)[0];if(void 0===i)return r;n[i]=r;return e}function getAt(e,t){for(var r=0;r<t.length;r++){var n=t[r];if(!Object.propertyIsEnumerable.call(e,n))return;e=e[n]}return e}return t};var p=o.Store=function(){var e=new s;var t=e.items=[];e.has=function(e){return void 0!=t[e]};e.get=function(r){return e.has(r)?wrap(t[r]):null};e.add=function(e,r){void 0==r&&(r=t.length);t[r]=e;return r};e.cull=function(e){"function"==typeof e&&(e=t.indexOf(e));delete t[e];return e};e.indexOf=function(e){if(t.indexOf)return t.indexOf(e);for(var r=0;r<t.length;r++)if(t[r]===e)return r;return-1};function wrap(e){return function(){e.apply(this||n,arguments);autoCull(e)}}function autoCull(t){if("number"==typeof t.times){t.times--;if(0==t.times){var r=e.cull(t);e.emit("cull",r)}}}return e};var m=o.parseArgs=function(e){var t={};forEach([].slice.call(e),(function(e){if("string"===typeof e)e.match(/^\d+$/)?t.port=parseInt(e,10):e.match("^/")?t.path=e:t.host=e;else if("number"===typeof e)t.port=e;else if("function"===typeof e)t.block=e;else if("object"===typeof e)e&&"function"===typeof e.listen?t.server=e:e&&"function"===typeof e.write?t.stream=e:forEach(c(e),(function(r){t[r]="port"===r?parseInt(e[r],10):e[r]}));else if("undefined"!==typeof e)throw new Error("Not sure what to do about "+typeof e+" objects")}));return t};var h=a.exports;const v=a.exports.Session,d=a.exports.Scrubber,b=a.exports.Store,y=a.exports.parseArgs;export default h;export{d as Scrubber,v as Session,b as Store,y as parseArgs};

