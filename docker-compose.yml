services:
  pg:
    image: postgres:latest
    environment:
      POSTGRES_DB: partecipo
      POSTGRES_USER: partecipo
      POSTGRES_PASSWORD: ChangeMe
    volumes:
      - partecipo-pg-data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d $${POSTGRES_DB} -U $${POSTGRES_USER}" ]
      interval: 1s
      timeout: 5s
      retries: 5
  redis:
    image: redis:latest
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 1s
      timeout: 3s
      retries: 5
  rails:
    image: partecipo
    build: ./
    depends_on:
      pg:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - partecipo-rails-storage:/rails/storage
    environment:
      ### RAILS_RESTRICTED, If true entire site require authentication
      # RAILS_RESTRICTED: true
      RAILS_MASTER_KEY: 5cdcc57160c136623510fa73c7a7587f
      RAILS_TITLE: Partecipo
      RAILS_DESCRIPTION: Partecipo description
      RAILS_HEAD_URL: /head.html
      RAILS_FOOTER_URL: /footer.html
      RAILS_HOST: partecipo.it
      ### RAILS_DEVISE_MODULES, Mudules for devise authentication
      ### - only database
      ###   database_authenticatable registerable recoverable rememberable validatable confirmable timeoutable trackable lockable
      ### - Mixed database and omniauth (OIDC)
      ###   database_authenticatable registerable recoverable rememberable validatable confirmable timeoutable trackable lockable omniauthable
      ### - Only omniauth (OIDC)
      ###   validatable timeoutable trackable omniauthable
      RAILS_DEVISE_MODULES: database_authenticatable registerable recoverable rememberable validatable confirmable timeoutable trackable lockable omniauthable
      ### RAILS_OIDC_ISSIER, OIDC IDP base url 
      RAILS_OIDC_ISSUER: https://my_issuer.com
      ### RAILS_OIDC_USERNAME, Claim used to set user `username`
      RAILS_OIDC_USERNAME: email
      ### RAILS_OIDC_NAME, claim used to set user `name` param
      RAILS_OIDC_NAME: given_name
      ### RAILS_OIDC_SURNAME, claim used to set user `surname` param
      RAILS_OIDC_SURNAME: family_name
      ### RAILS_OIDC_IDENTIFIER, String required to identify this OIDC RP from the IDP
      RAILS_OIDC_IDENTIFIER: partecipo
      ### RAILS_OIDC_SECRET, Secret string to identify this OIDC RP from the IDP
      RAILS_OIDC_SECRET: MySuperSecureSecret
      ### RAILS_OIDC_CLAIMS, list of claims required
      RAILS_OIDC_CLAIMS: sub email given_name family_name
      ### RAILS_MAX_THREADS, pool connection to PG database
      RAILS_MAX_THREADS: 5
      ### RAILS_DB_URL, PG connection string
      RAILS_DB_URL: postgres://partecipo:ChangeMe@pg/partecipo
      ### RAILS_SMTP_USERNAME, username for smtp server
      RAILS_SMTP_USERNAME: partecipo
      ### RAILS_SMTP_PASSWORD, password for smtp server
      RAILS_SMTP_PASSWORD: MyPassword
      ### RAILS_SMTP_ADDRESS, hostname to call smtp server
      RAILS_SMTP_ADDRESS: smtp.partecipo.it
      ### RAILS_SMPT_PORT, tcp port to smtp server 
      RAILS_SMPT_PORT: 587
      ### RAILS_SMTP_AUTHENTICATION, authentication method
      RAILS_SMTP_AUTHENTICATION: plain
      ### TLS_DOMAIN, if present, Thruster server enable TLS with Let's encrypt
      # TLS_DOMAIN: partecipo.it 
      ### BAD_GATEWAY_PAGE, address for proxy error page
      BAD_GATEWAY_PAGE: ./public/500.html
      
    ports:
      - "80:80"
      - "443:443"

volumes:
  partecipo-rails-storage:
  partecipo-pg-data:
